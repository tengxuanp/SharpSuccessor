name: Build BadSuccessor (Desktop .NET Framework)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # OPTIONAL but recommended:
      # Retarget project file(s) from v4.6.1 to v4.7.2 so the runner has the reference assemblies.
      # If you prefer v4.8, change v4.7.2 -> v4.8 below.
      - name: Retarget .NET Framework 4.6.1 -> 4.7.2 (optional, recommended)
        shell: pwsh
        run: |
          $pattern = '<TargetFrameworkVersion>v4.6.1</TargetFrameworkVersion>'
          $replacement = '<TargetFrameworkVersion>v4.7.2</TargetFrameworkVersion>'
          Get-ChildItem -Path . -Recurse -Filter *.csproj | ForEach-Object {
            $p = $_.FullName
            $content = Get-Content $p -Raw
            if ($content -like "*v4.6.1*") {
              $content -replace [regex]::Escape($pattern), $replacement | Set-Content $p -Encoding UTF8
              Write-Output "Updated $p"
            } else {
              Write-Output "No v4.6.1 target in $p"
            }
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet (optional helper)
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore BadSuccessor.sln

      - name: Build solution (Release | Any CPU)
        run: msbuild BadSuccessor.sln /p:Configuration=Release /p:Platform="Any CPU" /m

      - name: Show Release outputs (debug)
        run: |
          Write-Output "=== Release outputs under repo ==="
          Get-ChildItem -Path . -Recurse -Force -Filter *.exe | Where-Object { $_.FullName -match '\\bin\\Release\\' } | ForEach-Object { Write-Output $_.FullName }

      - name: Upload build artifacts (any exe in bin/Release)
        uses: actions/upload-artifact@v4
        with:
          name: BadSuccessor-executables
          path: |
            **/bin/Release/**/*.exe
            **/bin/Release/**/*.msi
            **/bin/Release/**/*.zip
