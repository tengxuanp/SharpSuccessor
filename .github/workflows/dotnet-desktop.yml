name: Build Desktop (.NET)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2025
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find solution file
        id: find_sln
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Path . -Recurse -Filter *.sln | Select-Object -First 1
          if (-not $sln) { Write-Error "No .sln file found in repo."; exit 1 }
          Write-Output "##[set-output name=path;]$($sln.FullName)"
          Write-Output "Found solution: $($sln.FullName)"

      - name: Show repository tree (debug)
        run: Get-ChildItem -Recurse -Force -File | Select-Object FullName | ForEach-Object { Write-Output $_.FullName }

      # OPTIONAL: Retarget v4.6.1 -> v4.7.2 to avoid MSB3644 on GitHub runners
      - name: Retarget .csproj files from v4.6.1 -> v4.7.2 (recommended)
        shell: pwsh
        run: |
          $pattern = '<TargetFrameworkVersion>v4.6.1</TargetFrameworkVersion>'
          $replacement = '<TargetFrameworkVersion>v4.7.2</TargetFrameworkVersion>'
          Get-ChildItem -Path . -Recurse -Filter *.csproj | ForEach-Object {
            $p = $_.FullName
            $text = Get-Content $p -Raw
            if ($text -like "*v4.6.1*") {
              $text -replace [regex]::Escape($pattern), $replacement | Set-Content $p -Encoding UTF8
              Write-Output "Patched $p"
            }
          }

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        run: nuget restore "${{ steps.find_sln.outputs.path }}"

      - name: Build solution (Release)
        run: msbuild "${{ steps.find_sln.outputs.path }}" /p:Configuration=Release /p:Platform="Any CPU" /m

      - name: Show Release outputs (debug)
        run: |
          Write-Output "=== Release outputs under repo ==="
          Get-ChildItem -Path . -Recurse -Force -Filter *.exe | Where-Object { $_.FullName -match '\\bin\\Release\\' } | ForEach-Object { Write-Output $_.FullName }

      - name: Upload build artifacts (any exe in bin/Release)
        uses: actions/upload-artifact@v4
        with:
          name: build-executables
          path: |
            **/bin/Release/**/*.exe
            **/bin/Release/**/*.msi
            **/bin/Release/**/*.zip
